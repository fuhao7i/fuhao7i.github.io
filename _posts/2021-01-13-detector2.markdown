---
layout:     post
title:      "DetectorðŸŽ¯2â€”â€”mmdetection æ•°æ®é›†å‡†å¤‡build_datasetå‡½æ•°è¯¦è§£"
subtitle:   " \"mmdetection æ•°æ®é›†å‡†å¤‡\""
date:       2021-01-13 17:32:00
author:     "fuhao7i"
header-img: "img/in-post/mubiaojiance.jpg"
catalog: true
tags:
    - DetectorðŸŽ¯
---

> mmdetection æ•°æ®é›†å‡†å¤‡ï¼ŒåŒ…æ‹¬è®­ç»ƒæ•°æ®é›†å’Œæµ‹è¯•æ•°æ®é›†

# 1. è®­ç»ƒæ•°æ®é›†

åœ¨train.pyæ–‡ä»¶ä¸­ï¼Œæž„å»ºè®­ç»ƒæ•°æ®é›†ã€‚

```python
from mmdet.datasets import build_dataset

train_dataset = build_dataset(cfg.data.train)
```

## 1.1 å‚æ•°cfg.data.train

```python
# dataset settings
dataset_type = 'VOCDataset'
data_root ='data/VOCdevkit/VOC2007/'
img_norm_cfg = dict(
    mean=[123.675, 116.28, 103.53], std=[58.395, 57.12, 57.375], to_rgb=True)

train_pipeline = [
    dict(type='LoadImageFromFile'),
    dict(type='LoadAnnotations', with_bbox=True),
    dict(
        type='Resize',
       # img_scale=(1333, 800),
        img_scale=(800,600),
        keep_ratio=True),
    dict(type='RandomFlip', flip_ratio=0.5),
    dict(type='Normalize', **img_norm_cfg),
    dict(type='Pad', size_divisor=32),
    dict(type='DefaultFormatBundle'),
    dict(type='Collect', keys=['img', 'gt_bboxes', 'gt_labels']),
]


train=dict(
        type=dataset_type,
        ann_file=data_root + 'ImageSets/Main/train.txt',
        img_prefix=data_root ,
        pipeline=train_pipeline)
```

## 1.2 å‡½æ•°build_dataset()

å…¶ä¸­ï¼Œbuild_datasetå‡½æ•°åœ¨mmdetæ–‡ä»¶å¤¹çš„datasetsæ–‡ä»¶å¤¹ä¸‹çš„builder.pyã€‚   

`./mmdet/datasets/builder.py`

```python
def build_dataset(cfg, default_args=None):
    if isinstance(cfg, (list, tuple)):
        dataset = ConcatDataset([build_dataset(c, default_args) for c in cfg])
    elif cfg['type'] == 'RepeatDataset':
        dataset = RepeatDataset(
            build_dataset(cfg['dataset'], default_args), cfg['times'])
    elif isinstance(cfg['ann_file'], (list, tuple)):
        dataset = _concat_dataset(cfg, default_args)
    else:
        dataset = build_from_cfg(cfg, DATASETS, default_args)

    return dataset
```

è¿™é‡Œæˆ‘ä»¬ä¼šæ‰§è¡Œ`dataset = build_from_cfg(cfg, DATASETS, default_args)`. æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ã€‚

## 1.2.1 å…¨å±€å˜é‡(æ³¨å†Œè¡¨)DATASETSçš„æž„å»º

`mmdet/datasets/registry.py`

è¿™é‡Œå°†ç±»`Registry`å®žä¾‹åŒ–ï¼Œæ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ã€‚

```python
from mmdet.utils import Registry

DATASETS = Registry('dataset')
PIPELINES = Registry('pipeline')
```

ç„¶åŽæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹`Registry`ç±»:

`mmdet/utils/registry.py`

```python
import inspect

import mmcv


class Registry(object):

    def __init__(self, name):
        self._name = name   #Registryç±»çš„åå­—
        self._module_dict = dict()  #åˆ›å»ºä¸€ä¸ªæ¨¡å—å­—å…¸

    def __repr__(self):
        format_str = self.__class__.__name__ + '(name={}, items={})'.format(
            self._name, list(self._module_dict.keys()))
        return format_str

    @property   #å°†æ–¹æ³•ä¿®é¥°ä¸ºç±»å±žæ€§
    def name(self):
        return self._name

    @property
    def module_dict(self):
        return self._module_dict

    def get(self, key):
        return self._module_dict.get(key, None)

    def _register_module(self, module_class):   #Registryç±»çš„ä¸»è¦æ–¹æ³•ï¼Œç”¨æ¥æ³¨å†Œæ¨¡å—ã€‚
        """Register a module.

        Args:
            module (:obj:`nn.Module`): Module to be registered.
        """
        if not inspect.isclass(module_class):
            raise TypeError('module must be a class, but got {}'.format(
                type(module_class)))
        module_name = module_class.__name__
        if module_name in self._module_dict:
            raise KeyError('{} is already registered in {}'.format(
                module_name, self.name))
        self._module_dict[module_name] = module_class

    def register_module(self, cls):
        self._register_module(cls)
        return cls
```

ç„¶åŽæˆ‘ä»¬ç‚¹å¼€`mmdet/datasets`ä¸‹çš„æ•°æ®é›†å®šä¹‰pyæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥`voc.py`æ•°æ®é›†ä¸ºä¾‹ã€‚

## 1.2.2 æ•°æ®é›†å®šä¹‰æ–‡ä»¶ voc.py

è¿™é‡Œæˆ‘ä»¬ç”¨ä¿®é¥°ç¬¦@ä¿®é¥°: `@DATASETS.register_module`ï¼Œå°±æ˜¯å°†`ç±»VOCDataset`ä½œä¸ºå‚æ•°ä¼ å…¥`DATASETS.register_module()`å‡½æ•°ã€‚

```python
@DATASETS.register_module
class VOCDataset(XMLDataset):
```

### 1.2.2.1 çˆ¶ç±»XMLDataset

VocDataset ç»§æ‰¿è‡ª XMLDataset, XMLDataset åˆç»§æ‰¿è‡ª CustomDataset, CustomDatasetç»§æ‰¿è‡ª **Dataset** `from torch.utils.data import Dataset`. 

```python
class XMLDataset(CustomDataset):
	def load_annotations(self, ann_file):  # ç”¨äºŽåˆå§‹åŒ–VocDatasetçš„ï¼Œä¸»è¦åˆå§‹åŒ–ç®—imgsçš„ä½ç½®ï¼Œimgså’Œannotationsçš„å…³è”å…³ç³»ç­‰
		...
	def get_ann_info(self, idx):  # ç”¨äºŽåœ¨train/val/testä¸­è°ƒå–annotations
		...
```

ç„¶åŽçœ‹ä¸€ä¸‹åœ¨è®­ç»ƒä¸­æ—¶å¦‚ä½•è°ƒç”¨çš„ï¼ŒXMLDatasetç»§æ‰¿CustomDatsetï¼Œåœ¨trainè¿‡ç¨‹ä¸­è°ƒç”¨çš„æ—¶CustomDatasetçš„å‡½æ•°:

```python
# ./mmdnet/datasets/custom.py

class CustomDataset(Dataset):

    def __init__(...):
        ...
        # load annotations (and proposals)
        self.img_infos = self.load_annotations(self.ann_file)
        ...
        # processing pipeline
        self.pipeline = Compose(pipeline)

    def __getitem__(self, idx):     # é‡è½½Datasetçš„ï¼Œå°±æ˜¯åœ¨trainè¿‡ç¨‹ä¸­åŠ è½½dataå’Œtargetçš„ï¼Œå…¶ä¸­ç”¨äº†prepare_train_img
       if self.test_mode:
           return self.prepare_test_img(idx)
       while True:
           data = self.prepare_train_img(idx)
           if data is None:
               idx = self._rand_another(idx)
               continue
           return data

    def prepare_train_img(self, idx):
        img_info = self.img_infos[idx]
        ann_info = self.get_ann_info(idx)
        results = dict(img_info=img_info, ann_info=ann_info)
        if self.proposals is not None:
            results['proposals'] = self.proposals[idx]
        self.pre_pipeline(results)
        return self.pipeline(results)
```

```Bash
æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°CustomDatasetä¸­ä½¿ç”¨load_annotationsåˆå§‹åŒ–datasetï¼Œä½¿ç”¨get_ann_infoåŠ è½½targetï¼Œæ‰€ä»¥ç»§æ‰¿CustomDatasetéœ€è¦å®šä¹‰è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å¯ä»¥å®Œæˆè‡ªå·±Datasetçš„å®šä¹‰ã€‚
```

## 1.3 å‡½æ•° build_from_cfg()

æˆ‘ä»¬ç»§ç»­æ¥çœ‹`dataset = build_from_cfg(cfg, DATASETS, default_args)`.

```python
def build_from_cfg(cfg, registry, default_args=None):
    """Build a module from config dict.

    Args:
        cfg (dict): Config dict. It should at least contain the key "type".
        registry (:obj:`Registry`): The registry to search the type from.
        default_args (dict, optional): Default initialization arguments.

    Returns:
        obj: The constructed object.
    """
    assert isinstance(cfg, dict) and 'type' in cfg
    assert isinstance(default_args, dict) or default_args is None
    args = cfg.copy()
    obj_type = args.pop('type')
    if mmcv.is_str(obj_type):
        obj_type = registry.get(obj_type)   #å°†cfgä¸­cfgä¸­çš„'VOCDataset'å˜æˆVOCDatasetè¿™ä¸ªç±»èµ‹å€¼ç»™obj_cls
        if obj_type is None:
            raise KeyError('{} is not in the {} registry'.format(
                obj_type, registry.name))
    elif inspect.isclass(obj_type):
        obj_cls = obj_type
    else:
        raise TypeError('type must be a str or valid type, but got {}'.format(
            type(obj_type)))
    if default_args is not None:
        for name, value in default_args.items():
            args.setdefault(name, value)
    return obj_type(**args)     #å®žä¾‹åŒ–VOCDatasetå¹¶è¿”å›žï¼Œä¸€è·¯è¿”å›žç»™test.pyä¸­çš„dataset
```

```Bash
pytorch çš„æ•°æ®åŠ è½½åˆ°æ¨¡åž‹çš„æ“ä½œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š

â‘  åˆ›å»ºä¸€ä¸ª Dataset å¯¹è±¡
â‘¡ åˆ›å»ºä¸€ä¸ª DataLoader å¯¹è±¡
â‘¢ å¾ªçŽ¯è¿™ä¸ª DataLoader å¯¹è±¡ï¼Œå°†img, labelåŠ è½½åˆ°æ¨¡åž‹ä¸­è¿›è¡Œè®­ç»ƒ
```

```python
# https://blog.csdn.net/g11d111/article/details/81504637 éžå¸¸å¥½çš„Dataloaderè¯¦è§£
dataset = MyDataset()
dataloader = DataLoader(dataset)
num_epoches = 100
for epoch in range(num_epoches):
    for img, label in dataloader:
        ...
```

# 2. æµ‹è¯•æ•°æ®é›†

å’Œè®­ç»ƒæ•°æ®é›†çš„æž„å»ºç›¸åŒã€‚



### tips1: isinstance(object, classinfo)å‡½æ•°è¯¦è§£:

```Bash
* object -- å®žä¾‹å¯¹è±¡ã€‚
* classinfo -- å¯ä»¥æ˜¯ç›´æŽ¥æˆ–é—´æŽ¥ç±»åã€åŸºæœ¬ç±»åž‹æˆ–è€…ç”±å®ƒä»¬ç»„æˆçš„å…ƒç»„ã€‚

classinfoå¯ä»¥æ˜¯ï¼šintï¼Œfloatï¼Œboolï¼Œcomplexï¼Œstr(å­—ç¬¦ä¸²)ï¼Œlistï¼Œdict(å­—å…¸)ï¼Œsetï¼Œtupleï¼Œå…·ä½“çš„ç±»

åˆ¤æ–­å¯¹è±¡objectçš„ç±»åž‹æ˜¯å¦å’Œclassinfoçš„ç±»åž‹ç›¸åŒã€‚ç›¸åŒåˆ™è¿”å›žTrueï¼Œå¦åˆ™è¿”å›žFalseã€‚
```

> isinstance() ä¸Ž type() åŒºåˆ«ï¼š
>   type() ä¸ä¼šè®¤ä¸ºå­ç±»æ˜¯ä¸€ç§çˆ¶ç±»ç±»åž‹ï¼Œä¸è€ƒè™‘ç»§æ‰¿å…³ç³»ã€‚
>   isinstance() ä¼šè®¤ä¸ºå­ç±»æ˜¯ä¸€ç§çˆ¶ç±»ç±»åž‹ï¼Œè€ƒè™‘ç»§æ‰¿å…³ç³»ã€‚
> å¦‚æžœè¦åˆ¤æ–­ä¸¤ä¸ªç±»åž‹æ˜¯å¦ç›¸åŒæŽ¨èä½¿ç”¨ isinstance()ã€‚

`e.g`
```python
>>> a = 2
>>> isinstance (a,(str,int,list))    # æ˜¯å…ƒç»„ä¸­çš„ä¸€ä¸ªè¿”å›ž True
True
```