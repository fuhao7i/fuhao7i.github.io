---
layout:     encryption
title:      "é˜¶æ®µæ€§å­¦ä¹ æ€»ç»“ğŸ”‘1â€”â€”HitDetæ”¹è¿›"
subtitle:   " \"HitDet\""
date:       2021-01-15 11:44:00
author:     "fuhao7i"
header-img: "img/in-post/stage.jpg"
catalog: true
tags:
    - é˜¶æ®µæ€§å­¦ä¹ æ€»ç»“ğŸ”‘
---

> å¯¹HitDetæ¨¡å‹è¿›è¡Œå­¦ä¹ ä¸æ”¹è¿›
>> "HitDet"
>>> Posted by fuhao7i on January 15, 2021

========================================================================
                                                                          
<center><font face='é»‘ä½“' color='#F4606C' size= 12 >HitDetæ”¹è¿›</font></center>      
                                                                         
========================================================================

# 1. é™†ä¸Šæ¨¡å—æå–ç‰¹å¾å±‚å‰10å±‚

## 1.1 configs/nas_trinity/2stage_hitdet_out10.py

å¤åˆ¶`2stage_hitdet.py`, é‡å‘½åä¸º`2stage_hitdet_out10.py`,ä¿®æ”¹`backbone`: 

```python
model = dict(
    type='FasterRCNN',
    pretrained='./ImageNet-pretrained/fbhit_7747.pth',
    backbone=dict(
        type='FBNet_out10',
        out_indices=(4, 8, 16, 22),
        frozen_stages=-1,
        arch='fbnet_hit'),
```

## 1.2 mmdet/models/backbones/fbnet_out10.py

å¤åˆ¶`fbnet.py`, é‡å‘½åä¸º`fbnet_out10.py`,ä¿®æ”¹`forwardå‡½æ•°`:

åœ¨é™†ä¸Šæ¨¡å—å‰å‘ä¼ æ’­æ—¶ï¼Œè¾“å‡ºå‰10å±‚ç‰¹å¾å±‚ã€‚
```python
    def forward(self, x, alphas=None):
        outs = []
        cnt = 0
        out10 = []
        for i, layer in enumerate(self.layers):
            # fuhao7i------------------
            # æå–é™†ä¸Šæ¨¡å—1â€”â€”10å±‚
            # =========================
            x = layer(x)
            if i in self.out_indices:
                outs.append(x)

            if i > 0 and i <= 10:
                out10.append(x)
                

        return outs, out10
```

## 1.3 mmdet/models/backbones/__init__.py

åŠ å…¥`fbnet_out10`
```python
__all__ = ['ResNet', 'make_res_layer', 'ResNeXt', 'SSDVGG', 'HRNet', 'MobileNetV2', 'DetNas', 'FBNet', 'MnasNet', 'FBNet_out10']
```

## 1.4 mmdet/models/detectors/two_stage.py

æ–°å¢ä¸€ä¸ª`extract_feat_out10å‡½æ•°`

```python
    # fuhao7i------------------
    # æå–é™†ä¸Šæ¨¡å—1â€”â€”10å±‚
    # =========================
    def extract_feat_out10(self, img):
        x, out10 = self.backbone(img)
        if self.with_neck:
            x = self.neck(x)
            if len(x) >= 2:
                if x[1] is not None:
                    x = x
                else:
                    x = x[0]
        return x, out10
```

# 2. å’Œæ°´ä¸‹æ¨¡å—å‰10å±‚ç‰¹å¾å±‚è¿›è¡Œå †å 

## 2.1 mmdet/models/backbones/fbnet.py

é¦–å…ˆä¿®æ”¹`build_backboneå‡½æ•°`ï¼Œå› ä¸ºå‰10å±‚ç‰¹å¾å±‚è¿›è¡Œå †å æ—¶ï¼Œé€šé“æ•°è¦åŠ å€ã€‚

```python
    def build_backbone(self, arch, input_size):
        genotypes = predefine_archs[arch]['genotypes'] 
        strides = predefine_archs[arch]['strides'] 
        out_channels = predefine_archs[arch]['out_channels']
        
        self.layers = nn.ModuleList()
        self.layers.append(ConvBNReLU(input_size, in_channels=3, out_channels=out_channels[0], kernel_size=3, stride=strides[0], padding=1, 
                      bias=True, relu_type='relu', bn_type='bn'))
        input_size = input_size // strides[0]

        _in_channels = out_channels[0]
        # fuhao7i------------------
        # å‰10å±‚ç‰¹å¾å±‚å †å ï¼Œè¾“å…¥çš„ç‰¹å¾å±‚ä¼šç¿»å€(x1 + x2)
        # =========================
        index_out = 0
        for genotype, stride, _out_channels in zip(genotypes[1:], strides[1:], out_channels[1:]):
            if genotype.endswith('sb'):
                self.layers.append(SUPER_PRIMITIVES[genotype](input_size, _in_channels, _out_channels, stride))
            else:
                self.layers.append(PRIMITIVES[genotype](input_size, _in_channels, _out_channels, stride))
            input_size = input_size // stride
            if index_out < 10:
                _in_channels = _out_channels * 2
            else:
                _in_channels = _out_channels
        print("backbone.layers = ", len(self.layers))
        for m in self.modules():
            if isinstance(m, nn.SyncBatchNorm):
                m._specify_ddp_gpu_num(1)
```

ç„¶åä¿®æ”¹`forwardå‡½æ•°`:

```python
    def forward(self, x, out10, alphas=None):
        outs = []
        cnt = 0
        for i, layer in enumerate(self.layers):
            x = layer(x)
            if i > 0 and i <= 10:
                x = x + out10[i-1]
            if i in self.out_indices:
                outs.append(x)

        return outs
```

# 3. å¯¹é‡æ–°æ„å»ºçš„ç½‘ç»œè¿›è¡Œè®­ç»ƒ

`tools/train.py` --> `mmdet/apis/train.py` --> `mmcv/runner/runner.py`

## 3.1 

### 4.1 å¼„æ‡‚datasetæ˜¯æ€ä¹ˆè½½å…¥çš„ï¼Œdatasetçš„æ ¼å¼æ˜¯æ€æ ·çš„ã€‚ç†Ÿæ‚‰æœåŠ¡å™¨

### 4.2 ä¿®æ”¹å¥½runner, è¾“å‡ºå‰10å±‚ç‰¹å¾

### 4.3 å°†runnerä¸­ æ°´ä¸‹æ¨¡å—å’Œé™†ä¸Šæ¨¡å—ç»“åˆã€‚
#### 4.3.1 æ³¨æ„âš ï¸æ•°æ®é›†è¾“å…¥åˆ°ä¸¤ä¸ªæ¨¡å‹çš„batchå¤§å°ã€‚
#### 4.3.2 å¤šå›¾ç‰‡è¾“å…¥çš„æ—¶å€™ï¼Œæ€æ ·åŒºåˆ†out10ç‰¹å¾å±‚ã€‚
