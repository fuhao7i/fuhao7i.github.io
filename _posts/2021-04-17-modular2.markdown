---
layout:     post
title:      "Modular torchğŸ’Œ2â€”â€”Define your Dataset"
subtitle:   " \"Dataset for classification, semantic sementation, object detection or ...\""
date:       2021-04-17 20:27:00
author:     "fuhao7i"
header-img: "img/in-post/torch.jpg"
catalog: true
tags:
    - Modular torchğŸ’Œ
---

# 1. Dataset for classification

```python
class MyDataset(Dataset):  # åˆ›ç±»ï¼šMyDataset,ç»§æ‰¿torch.utils.data.Dataset
    def __init__(self, datatxt, transform=None):
        super(MyDataset, self).__init__()
        fh = open(datatxt, 'r')  # æ‰“å¼€txtï¼Œè¯»å–å†…å®¹
        data = []
        for line in fh:  # æŒ‰è¡Œå¾ªç¯txtæ–‡æœ¬ä¸­çš„å†…å®¹
            words = line.split(';')  # é€šè¿‡æŒ‡å®šåˆ†éš”ç¬¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œåˆ‡ç‰‡
            data.append((words[0], int(words[1])))  # æŠŠtxté‡Œçš„å†…å®¹è¯»å…¥dataåˆ—è¡¨ä¿å­˜ï¼Œwords[0]æ˜¯å›¾ç‰‡ä¿¡æ¯ï¼Œwords[1]æ˜¯label

        self.data = data
        self.transform = transform

    def __getitem__(self, index):  # æŒ‰ç…§ç´¢å¼•è¯»å–æ¯ä¸ªå…ƒç´ çš„å…·ä½“å†…å®¹
        fn, label = self.data[index]  # fnæ˜¯å›¾ç‰‡path
        img = Image.open('/content/drive/MyDrive/search/mmdetection/data/imagenet-underwater/train/' + fn).convert('RGB')  # from PIL import Image

        if self.transform is not None:  # æ˜¯å¦è¿›è¡Œtransform
            img = self.transform(img)
        return img, label  # returnå›å“ªäº›å†…å®¹ï¼Œåœ¨è®­ç»ƒæ—¶å¾ªç¯è¯»å–æ¯ä¸ªbatchï¼Œå°±èƒ½è·å¾—å“ªäº›å†…å®¹

    def __len__(self):  # å®ƒè¿”å›çš„æ˜¯æ•°æ®é›†çš„é•¿åº¦ï¼Œå¿…é¡»æœ‰
        return len(self.data)
```

# 2. Dataset for semantic segmentation

```python
class MyDataset(Dataset):
    def __init__(self,data_txt,split,image_size,num_classes,random_data):
        super(MyDataset, self).__init__()

        self.data_txt = data_txt
        self.len_dataset = len(data_txt)
        self.split = split
        self.image_size = image_size
        self.num_classes = num_classes

        if self.split == 'train':
            self.path0 = '/content/drive/MyDrive/è¯­ä¹‰åˆ†å‰²/dataset/jpg'
            self.path1 = '/content/drive/MyDrive/è¯­ä¹‰åˆ†å‰²/dataset/L_png'
        else:
            self.path0 = '/content/drive/MyDrive/è¯­ä¹‰åˆ†å‰²/dataset/val_jpg'
            self.path1 = '/content/drive/MyDrive/è¯­ä¹‰åˆ†å‰²/dataset/L_val_png'

    def __getitem__(self, index):
        if index == 0:
            shuffle(self.data_txt)
            
        annotation_line = self.data_txt[index]
        name0 = annotation_line.split(';')[0]
        name1 = annotation_line.split(';')[1].replace("\n", "")
        # ä»æ–‡ä»¶ä¸­è¯»å–å›¾åƒ
        jpg = Image.open(self.path0 + '/' + name0)
        png = Image.open(self.path1 + '/' + name1)

        # ä»æ–‡ä»¶ä¸­è¯»å–å›¾åƒ
        png = np.array(png)

        png[png >= self.num_classes] = 0
        
        # è½¬åŒ–æˆone_hotç¼–ç çš„å½¢å¼
        seg_labels = np.eye(self.num_classes)[png.reshape([-1])]
        seg_labels = seg_labels.reshape((int(self.image_size[1]),int(self.image_size[0]),self.num_classes))

        # å°†jpgçš„æ ¼å¼ä»(h, w, c) => (c, h, w)ï¼Œtorchè¦æ±‚å›¾ç‰‡é€šé“åœ¨å‰
        jpg = np.transpose(np.array(jpg),[2,0,1])/255
        
        # è¾“å‡º
        # jpg: (3, 512, 512) å½’ä¸€åŒ–åˆ°[0, 1]
        # png: (512, 512)    æ¯ä¸€ä¸ªåƒç´ ç‚¹å­˜çš„æ˜¯å®ƒçš„ç±»åˆ«, 0,1,2,3,4
        # seg_labels: (512, 512, Num_classes) one-hotç¼–ç æ ¼å¼
        return jpg, png, seg_labels

    def __len__(self):
        return self.train_batches
```

# 3. Dataset for object detection

