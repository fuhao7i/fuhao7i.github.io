<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 数学公式 -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
        }
    });
    </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 @fuhao7i 的个人博客，我还很年轻，吃苦趁现在！">
    <meta name="keywords"  content="深度学习, 计算机视觉, OpenCv">
    <meta name="theme-color" content="#000000">
    
    <!--不蒜子-->
    <meta name="referrer" content="no-referrer-when-downgrade">

    <!-- Open Graph -->
    <meta property="og:title" content="小菊的语义分割3🌼——像素级分类实现原理及数据预处理 - fuhao7i的博客 | fuhao7i Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="
  通过小菊的语义分割1🌼，我们已经知道了语义分割其实就是像素级的分类任务，也就是说它要做的是给每一个像素点进行分类，那我们具体应该怎样实现这个特殊的分类任务呢？————不急，我们先来看一下普通的图像分类任务是怎样实现的

">
    
    <meta property="article:published_time" content="2021-03-27T22:00:00Z">
    
    
    <meta property="article:author" content="fuhao7i">
    
    
    <meta property="article:tag" content="小菊的语义分割🌼">
    
    
    <meta property="og:image" content="https://fuhao7i.github.io/img/github.jpg">
    <meta property="og:url" content="https://fuhao7i.github.io/2021/03/27/xiaoju3/">
    <meta property="og:site_name" content="fuhao7i的博客 | fuhao7i Blog">
    
    <title>小菊的语义分割3🌼——像素级分类实现原理及数据预处理 - fuhao7i的博客 | fuhao7i Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://fuhao7i.github.io/2021/03/27/xiaoju3/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">fuhao7i Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        <li>
                            <a href="/message/">Message</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Post Header -->




<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/in-post/xiaoju.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E5%B0%8F%E8%8F%8A%E7%9A%84%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%F0%9F%8C%BC" title="小菊的语义分割🌼">小菊的语义分割🌼</a>
                        
                    </div>
                    <h1>小菊的语义分割3🌼——像素级分类实现原理及数据预处理</h1>
                    
                    <h2 class="subheading"> "数据标签预处理, Softmax进行像素级分类原理"</h2>
                    <span class="meta">Posted by fuhao7i on March 27, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<blockquote>
  <p>通过小菊的语义分割1🌼，我们已经知道了语义分割其实就是像素级的分类任务，也就是说它要做的是给每一个像素点进行分类，那我们具体应该怎样实现这个特殊的分类任务呢？————不急，我们先来看一下普通的图像分类任务是怎样实现的</p>
</blockquote>

<h1 id="0-图像分类任务实现原理">0. 图像分类任务实现原理</h1>

<p>其实我们的语义分割——像素级分类和我们的普通图像分类任务还是非常相似的，只不过是一个给像素点进行分类，一个给整个图像进行分类，它们的标签处理方式和最后的损失计算都是非常相似的。</p>

<p>首先，我们假设有这样一堆图片，里面总共有3个类——猫，狗和狼，那么我们定义标签的时候可以将猫作为第0类，狗是第1类，狼是第2类，然后给它们转换成分类常用的one-hot编码格式，如下所示:</p>

<pre><code class="language-Bash"> 类别    标签    one-hot  
 猫      0      [1, 0, 0]
 狗      1      [0, 1, 0]
 狼      2      [0, 0, 1]
</code></pre>

<p>我们把每一张图片和它的one-hot编码格式标签对应起来，就可以用于后面的损失函数计算了。</p>

<p>接下来我们再看看我们的分类网络的输出是怎样的。分类网络的输出是一个一维数组[…]，具体数组里面有几个元素和我们要分的类别有关，我们这里分3类，数组的长度就为3————[x0, x1, x2]，之后我们<code class="language-plaintext highlighter-rouge">Softmax([x0, x1, x2])</code>，得到[p0, p1, p2]，其中p0+p1+p2=1，p0代表的是图像为第0类的概率，p1代表的是图像为第1类的概率，以此类推。最大概率对应种类就是分类网络预测的图像的种类。<code class="language-plaintext highlighter-rouge">例</code> 我们将标签为[0, 1, 0]的图像输入到分类网络得到输出[0.1, 0.7, 0.2]，其中最大概率0.7对应的类别为1，则分类网络任务该图像为狗。</p>

<p>最后我们来看一下分类网络损失的计算：<strong>交叉熵</strong></p>

\[\large loss = - (\sum\limits_{i=1}^N y\_true_i * ln( y\_pre_i )) \tag {1}\]

<p>其中 $0 &lt; y_pre_i &lt;= 1$。因为我们的y_true只有一个为1，其余全为0，带入可得我们的损失为 <strong>loss = - ln( y_prei )</strong>，带入我们上边的例子就是<strong>loss = -ln(0.7)</strong>,ln函数在<strong>(0,1]</strong>为增函数，加上负号为减函数，也就是说我们的分类网络只有提高图像分类正确的概率，我们的loss才会减小。</p>

<p><code class="language-plaintext highlighter-rouge">损失理解:</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="c1"># 类别    标签    one-hot  
# 猫      0      [1, 0, 0]
# 狗      1      [0, 1, 0]
# 狼      2      [0, 0, 1]
</span>
<span class="k">def</span> <span class="nf">crossentropy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]])</span>


<span class="k">print</span><span class="p">(</span><span class="s">"Keras:"</span><span class="p">,</span> <span class="n">K</span><span class="p">.</span><span class="n">categorical_crossentropy</span><span class="p">(</span><span class="n">K</span><span class="p">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">K</span><span class="p">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span>

<span class="n">loss1</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">loss2</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">loss1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss1</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">loss2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss2</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">loss1</span> <span class="o">+=</span> <span class="n">crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">loss2</span> <span class="o">+=</span> <span class="n">crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  

<span class="k">print</span><span class="p">(</span><span class="s">"ours :"</span><span class="p">,</span> <span class="n">loss1</span><span class="p">,</span> <span class="n">loss2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<pre><code class="language-Bash">Keras: tf.Tensor([0.5108256 1.2039728], shape=(2,), dtype=float32)
ours : 0.51082563 1.2039728
</code></pre>

<p>看懂了普通的图像分类任务之后，再看我们的语义分割，其实就是给每一个像素点对应一个one-hot编码标签，之后我们的语义分割网络的输出和分类网络的输出也是一样的，会输出每一个像素点对应每个类别的概率。如下所示：</p>

<pre><code class="language-Bash">       Output              Label
 [[0.4, 0.3, 0.3],      [[1, 0, 0],        # 第1个像素点
  [0.7, 0.2, 0.1],       [1, 0, 0],        # 第2个像素点
  [0.8, 0.2, 0.0],       [1, 0, 0],        # 第三个像素点
  [0.8, 0.1, 0.1],       [1, 0, 0],        # 第四个像素点
        ...                 ...
                 ]
</code></pre>

<p>接下来就让我们看一下它在语义分割中是怎样具体实现的吧</p>

<h1 id="1-数据预处理">1. 数据预处理</h1>

<p><code class="language-plaintext highlighter-rouge">思路:</code> 读取train.txt文件，获取训练图像及对应标签的文件路径，读取图像，将图像转化为<code class="language-plaintext highlighter-rouge">tensor</code>之后，<code class="language-plaintext highlighter-rouge">resize</code>调整图像尺寸大小并进行<code class="language-plaintext highlighter-rouge">归一化处理</code>，之后也可通过旋转，色偏，增加噪声等方式进行<code class="language-plaintext highlighter-rouge">数据增强</code>。注意要保证图像和标签的处理一致。</p>

<p><img src="https://img-blog.csdnimg.cn/20210327141350996.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">padding可以使图像在resize时不失真</code></p>

<h1 id="2-label-map-标签映射">2. label map 标签映射</h1>

<p><img src="https://img-blog.csdnimg.cn/20210328145544433.png" center="" /></p>

<p>如图就是我们的语义分割标签图像，相同颜色(像素值)的像素点代表的是同一类物体。假设像我们这个标签图像所展示的那样，我们需要分割出来图片中的猫和狗，那对我们的语义分割任务来说就是总共要分3类：0 背景；1 猫；2 狗；因此，我们需要创建一个<code class="language-plaintext highlighter-rouge">[Height, Width, N_classes]</code>数组来表示每一个像素点的类别；如下图所示：</p>

<p><img src="https://img-blog.csdnimg.cn/20210328145242405.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">label[0, 0] = [1, 0, 0]</code> 说明[0, 0]位置是背景，<code class="language-plaintext highlighter-rouge">label[1, 1] = [0, 1, 0]</code>说明[1, 1]这个像素点属于猫。我们<code class="language-plaintext highlighter-rouge">Reshape</code>之后好像更方便大家理解:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NCLASSES</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>one-hot 编码</strong></p>
<pre><code class="language-Bash">
 [[1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [0, 1, 0],
  [0, 0, 1],
  [0, 0, 1],
     ...
           ]
</code></pre>

<p>这就是我们最后用来和预测结果计算损失的数据啦🌼<code class="language-plaintext highlighter-rouge">相信大家对为什么这样做还有点云里雾里的感觉，那么接下来就让我们揭开语义分割的神秘面纱吧🌼</code></p>

<h1 id="3-像素级分类原理">3. 像素级分类原理</h1>

<p>了解完lable的具体格式之后，我们来看一下网络的最后几层设计:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'vaild'</span> <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_classes</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Softmax</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这个和我们label的处理是一致的，输出的是每一个像素点属于哪一类的概率，如下图：</p>

<p><img src="https://img-blog.csdnimg.cn/20210328152456675.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">tensor表示:</code></p>
<pre><code class="language-Bash">       Output              Label
 [[0.4, 0.3, 0.3],      [[1, 0, 0],
  [0.7, 0.2, 0.1],       [1, 0, 0],
  [0.8, 0.2, 0.0],       [1, 0, 0],
  [0.8, 0.1, 0.1],       [1, 0, 0],
        ...                 ...
                 ]
</code></pre>

<p>将我们处理之后的label和预测得到的结果传给我们的损失函数就能计算出loss了，这样我们就实现了像素级的分类————也就是<code class="language-plaintext highlighter-rouge">语义分割</code>了🌼</p>

<h3 id="帮助理解标签的处理">帮助理解标签的处理</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
     <span class="c1"># 默认背景为0
</span>     <span class="mi">76</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># 建筑物
</span>    <span class="mi">150</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 植被
</span>    <span class="mi">255</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="c1"># 道路
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">76</span><span class="p">],</span>
          <span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'int'</span><span class="p">)</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">:</span>
    <span class="n">labelmap</span><span class="p">[(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">labelmap</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">labelmap</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">labelmap</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>下面是包含了数据预处理，损失定义等整个模型训练过程的train.py文件，大家稍作修改就可以训练自己的语义分割模型了🌼</strong></p>

<p><strong><a href="https://keras.io/zh/models/model/">Keras实现</a></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Lambda</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">EarlyStopping</span>

<span class="c1"># 标签像素值对应的物体类别, 0为背景
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'[0 0 0]'</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># 背景
</span>    <span class="s">'[7 7 7]'</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'[26 26 26]'</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">576</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">576</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># train.txt和val.txt的文件路径
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">''</span>

<span class="c1"># train的图像和标签路径
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">''</span>
<span class="c1"># val的图像和标签路径
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">''</span>


<span class="c1"># labels映射
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">labelmap</span>


<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">],</span> \
        <span class="s">'mode must be ethier </span><span class="se">\'</span><span class="s">train</span><span class="se">\'</span><span class="s"> or </span><span class="se">\'</span><span class="s">val</span><span class="se">\'</span><span class="s">'</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Yval</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Ylabel</span> 

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path0</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span><span class="n">WIDTH</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mi">255</span>
            <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path1</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">label_map</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NCLASSES</span><span class="p">))</span>

            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

<span class="c1"># 定义损失函数
</span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">crossloss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">crossloss</span><span class="p">)</span><span class="o">/</span><span class="n">HEIGHT</span><span class="o">/</span><span class="n">WIDTH</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    
    <span class="c1"># 用于最后保存模型的路径
</span>    <span class="n">log_dir</span> <span class="o">=</span> <span class="s">''</span>

    <span class="c1"># 创建模型
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>

    <span class="c1"># 获取训练样本和验证样本的数目
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


    <span class="c1"># 设置学习率下降方法,val_loss验证损失连续5个epoch不下降就让学习率减半
</span>    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># 是否需要早停，当val_loss一直不下降的时候意味着模型基本训练完毕，可以停止
</span>    <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">min_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># 设置损失，优化器
</span>    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">,</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Train on {} samples, val on {} samples, with batch size {}.'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_val</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">))</span>

    <span class="c1"># 开始训练
</span>    <span class="n">model</span><span class="p">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'train'</span><span class="p">),</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_train</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'val'</span><span class="p">),</span>
            <span class="n">validation_steps</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_val</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
            <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">reduce_lr</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">])</span>

    <span class="n">model</span><span class="p">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">log_dir</span><span class="o">+</span><span class="s">'Dali.h5'</span><span class="p">)</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">上面的标签处理方便理解，但是时间复杂度高，在cup上处理慢，下面为改进版本:</code></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="c1"># import keras
</span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Lambda</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">models.decoders.segnet</span> <span class="kn">import</span> <span class="n">resnet50_segnet</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># logging 模块, 保存日志文件
# ===================&gt;
</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">'./work_dirs/segnet/segnet.log'</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">'a'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">handlers</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>

<span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">logger</span><span class="p">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
<span class="c1"># &lt;==================
</span>
<span class="c1"># 标签像素值对应的物体类别, 0为背景
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 默认背景为0
</span>     <span class="mi">76</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 建筑物
</span>    <span class="mi">150</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 植被
</span>    <span class="mi">255</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># 道路
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># train.txt和val.txt的文件路径
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">'./dataset/train.txt'</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">'./dataset/val.txt'</span>

<span class="c1"># train的图像和标签路径
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">'./dataset/jpg/'</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">'./dataset/png/'</span>
<span class="c1"># val的图像和标签路径
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">'./dataset/val_jpg/'</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">'./dataset/val_png/'</span>


<span class="c1"># labels映射
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">labelmap</span>


<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">],</span> \
        <span class="s">'mode must be ethier </span><span class="se">\'</span><span class="s">train</span><span class="se">\'</span><span class="s"> or </span><span class="se">\'</span><span class="s">val</span><span class="se">\'</span><span class="s">'</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Yval</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Ylabel</span> 

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path0</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span><span class="n">WIDTH</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mi">255</span>
            <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path1</span> <span class="o">+</span> <span class="n">name</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'L'</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">:</span>
                <span class="n">seg_labels</span><span class="p">[(</span><span class="n">img</span> <span class="o">==</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>
            <span class="c1"># print(seg_labels)
</span>            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">))</span>

<span class="c1"># 定义损失函数
</span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">crossloss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">crossloss</span><span class="p">)</span><span class="o">/</span><span class="n">HEIGHT</span><span class="o">/</span><span class="n">WIDTH</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    
    <span class="c1"># 用于最后保存模型的路径
</span>    <span class="n">log_dir</span> <span class="o">=</span> <span class="s">'./work_dirs/segnet/'</span>

    <span class="c1"># 创建模型
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">resnet50_segnet</span><span class="p">(</span><span class="n">n_classes</span><span class="o">=</span><span class="n">NCLASSES</span><span class="p">,</span> <span class="n">input_height</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">input_width</span><span class="o">=</span><span class="n">WIDTH</span><span class="p">)</span>

    <span class="c1"># 获取训练样本和验证样本的数目
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


    <span class="c1"># 设置学习率下降方法,val_loss验证损失连续5个epoch不下降就让学习率减半
</span>    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># 是否需要早停，当val_loss一直不下降的时候意味着模型基本训练完毕，可以停止
</span>    <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">min_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># 设置损失，优化器
</span>    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">,</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Train on {} samples, val on {} samples, with batch size {}.'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_val</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">))</span>
    <span class="c1"># print('Train on {} samples, val on {} samples, with batch size {}.'.format(num_train, num_val, BATCH_SIZE))
</span>
    <span class="c1"># 开始训练
</span>    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'train'</span><span class="p">),</span>
              <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_train</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
              <span class="n">validation_data</span><span class="o">=</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'val'</span><span class="p">),</span>
              <span class="n">validation_steps</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_val</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
              <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
              <span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">reduce_lr</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">])</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">log_dir</span><span class="o">+</span><span class="s">'segnet.h5'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><a href="https://fuhao7i.com/2021/03/12/dalitools2/">PyTorch实现</a></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="c1"># ===================&gt;
</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">'./work_dirs/segnet/segnet.log'</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">'a'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>

<span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">logger</span><span class="p">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
<span class="c1"># &lt;==================
</span>
<span class="c1"># 标签像素值对应的物体类别, 0为背景
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'[0 0 0]'</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1"># 背景
</span>    <span class="s">'[22 0 255]'</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># 建筑物
</span>    <span class="s">'[0 255 0]'</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 植被
</span>    <span class="s">'[255 255 255]'</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="c1"># 道路
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># train.txt和val.txt的文件路径
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">'./dataset/train.txt'</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">'./dataset/val.txt'</span>

<span class="c1"># train的图像和标签路径
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">'./dataset/jpg/'</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">'./dataset/png/'</span>
<span class="c1"># val的图像和标签路径
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">'./dataset/val_jpg/'</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">'./dataset/val_png/'</span>



<span class="c1"># labels映射
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">labelmap</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>  <span class="c1"># 创建类：MyDataset,继承torch.utils.data.Dataset
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatxt</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">datatxt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>  <span class="c1"># 打开txt，读取内容
</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>  <span class="c1"># 按行循环txt文本中的内容
</span>            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)</span>  <span class="c1"># 通过指定分隔符对字符串进行切片
</span>            <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># 把txt里的内容读入data列表保存，words[0]是图片信息，words[1]是label
</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">path_train</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">path_label</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>  <span class="c1"># 按照索引读取每个元素的具体内容
</span>        <span class="n">fn</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># fn是图片path
</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_train</span> <span class="o">+</span> <span class="n">fn</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_label</span> <span class="o">+</span> <span class="n">fn</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>



        <span class="c1"># from PIL import Image
</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># 是否进行transform
</span>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>  <span class="c1"># return回哪些内容，在训练时循环读取每个batch，就能获得哪些内容
</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># 它返回的是数据集的长度，必须有
</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>


    
    <span class="c1"># 实例化网络
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
    <span class="c1"># print(model)
</span>    
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span>  <span class="n">model</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="n">train_transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
     
        <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
        <span class="p">])</span>
    
    <span class="n">val_transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
    <span class="p">])</span>

    <span class="n">train_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">datatxt</span><span class="o">=</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transforms</span><span class="p">)</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">val_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">datatxt</span><span class="o">=</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">val_transforms</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">backbone</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>

    <span class="c1"># print('backbone parameters:', model.module.backbone)
</span>    <span class="n">num_epoches</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

    <span class="n">val_acc_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_model_wts</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
    <span class="n">best_acc</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># pretrained_dict = torch.load('/content/drive/MyDrive/search/mmdetection/data/resneXt_imagenet.pth')
</span>    <span class="c1"># model_dict = model.state_dict()
</span>    <span class="c1"># pretrained_dict = {k: v for k, v in pretrained_dict.items() if 'classifier' not in k}
</span>    <span class="c1"># for k in pretrained_dict:
</span>    <span class="c1">#     print(k)
</span>    <span class="c1"># model_dict.update(pretrained_dict)
</span>    <span class="c1"># model.load_state_dict(model_dict)
</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epoches</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Epoch {}/{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_epoches</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'-'</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
                <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Set model to training mode
</span>
                <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">running_corrects</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
                    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
                    <span class="c1"># print(labels)
</span>                    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>       

                    <span class="n">image</span><span class="p">[</span><span class="s">'img'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    <span class="n">image</span><span class="p">[</span><span class="s">'img_metas'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>

                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">extract_backbone</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
                    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
                    
                    <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">print</span><span class="p">(</span><span class="s">'loss:'</span><span class="p">,</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
                    <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">running_corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="c1"># print('{}/{}'.format(i * 50, len(train_loader.dataset)))
</span>
                <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">epoch_acc</span> <span class="o">=</span> <span class="n">running_corrects</span><span class="p">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>

                <span class="k">print</span><span class="p">(</span><span class="s">' Loss: {:.4f}, acc: {:.6f} , running_loss: {:6f} , len: {:.6f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_acc</span><span class="p">,</span> <span class="n">running_loss</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)))</span>    


            <span class="k">else</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>     
                <span class="c1"># if epoch &lt; 10:
</span>                <span class="c1">#     break
</span>                <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>   <span class="c1"># Set model to evaluate mode
</span>                
                <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">running_corrects</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">):</span>

                    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># print(labels)
</span>                    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>

                    <span class="n">image</span><span class="p">[</span><span class="s">'img'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    <span class="n">image</span><span class="p">[</span><span class="s">'img_metas'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">extract_backbone</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
                    <span class="c1"># print(outputs.shape, labels.shape)
</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    
                    <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


                    <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">running_corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># epoch_loss = running_loss / 1000.0
</span>                <span class="c1"># epoch_acc = running_corrects.double() / 1000.0
</span>                <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">epoch_acc</span> <span class="o">=</span> <span class="n">running_corrects</span><span class="p">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>

                <span class="k">print</span><span class="p">(</span><span class="s">' Val_loss: {:.4f}, Val_acc: {:.6f} '</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_acc</span><span class="p">))</span>
            
                <span class="k">if</span> <span class="n">epoch_acc</span> <span class="o">&gt;</span> <span class="n">best_acc</span><span class="p">:</span>
                    <span class="n">best_acc</span> <span class="o">=</span> <span class="n">epoch_acc</span>
                    <span class="n">best_model_wts</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
                    <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">best_model_wts</span><span class="p">,</span> <span class="s">'/content/drive/MyDrive/search/mmdetection/data/middle.pth'</span><span class="p">)</span>
                <span class="n">val_acc_history</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_acc</span><span class="p">)</span>

            <span class="k">print</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Best val Acc: {:4f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">best_acc</span><span class="p">))</span>
              
    <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">best_model_wts</span><span class="p">,</span> <span class="s">'/content/drive/MyDrive/search/mmdetection/data/resneXt_imagenet_338x600_best.pth'</span><span class="p">)</span>




<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

                
                <!--Donate start-->
                <iframe src="/donate.html" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;"  frameborder="0" scrolling="no"></iframe>
                <!--donate end-->
                
                <link rel="stylesheet" href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.css">
                <script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.min.js"></script>


                <div id="gitalk-container" style="margin: 30px;padding-bottom: 30px;"></div>
                <script>
                    var gitalk = new Gitalk({
                        clientID: '1695c83228c471fa58d4',
                        clientSecret: '3c6a9e3e05b2f978c97dff25925a155269f803c4',
                        repo: 'issues_fuhao7i',
                        owner: 'fuhao7i',
                        admin: ['fuhao7i'],
                        id: location.pathname,      // 用于标记评论是哪个页面的，确保唯一，并且长度小于50

                    })
                    gitalk.render('gitalk-container');    // 渲染Gitalk评论组件
                </script>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2021/03/27/xiaoju1/" data-toggle="tooltip" data-placement="top" title="小菊的语义分割1🌼——语义分割科普Semantic Segmentation">
                        Previous<br>
                        <span>小菊的语义分割1🌼——语义分割科普Semantic Segmentation</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/03/29/imageenhancement1/" data-toggle="tooltip" data-placement="top" title="GAN&Image Enhancement🐽1——AODNet: All-in-One Dehazing Network">
                        Next<br>
                        <span>GAN&Image Enhancement🐽1——AODNet: All-in-One Dehazing Network</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">


                

                

            </div>  

    <!-- Side Catalog Container -->
        
            <!--不蒜子统计-->
            

            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a href="https://fuhao7i.com/coffee.html" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" width="150" ></a>
                        <br>
                        <br>
                        <link rel="stylesheet" href="/iconfont.css">
                        <script src="/iconfont.js"></script>
                        views
                        <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-love"></use>
                        </svg>
                        <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>

                        <br>
                        <br>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                       
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            <style>
            .icon {
            width: 1em;
            height: 1em;
            vertical-align: -0.15em;
            fill: currentColor;
            overflow: hidden;
            }
            </style>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<a href="https://fuhao7i.com/coffee.html" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-red.png" alt="Buy Me A Coffee" width="150" ></a>
<br>
<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E9%98%BF%E8%8F%8A%E7%9A%84OpenCv%F0%9F%8E%A8"
                    title="阿菊的OpenCv🎨"
                    rel="1">阿菊的OpenCv🎨</a>
        
                <a data-sort="0028" 
                    href="/archive/?tag=Dali%E6%9D%82%E8%B4%A7%E9%93%BA%F0%9F%90%B0"
                    title="Dali杂货铺🐰"
                    rel="20">Dali杂货铺🐰</a>
        
                <a data-sort="0040" 
                    href="/archive/?tag=Neural+Network%F0%9F%A6%96"
                    title="Neural Network🦖"
                    rel="8">Neural Network🦖</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=Detector%F0%9F%8E%AF"
                    title="Detector🎯"
                    rel="5">Detector🎯</a>
        
                <a data-sort="0044" 
                    href="/archive/?tag=Dali%E5%B7%A5%E5%85%B7%E7%AE%B1%F0%9F%94%A7"
                    title="Dali工具箱🔧"
                    rel="4">Dali工具箱🔧</a>
        
                <a data-sort="0045" 
                    href="/archive/?tag=%E5%B0%8F%E8%8F%8A%E7%9A%84%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%F0%9F%8C%BC"
                    title="小菊的语义分割🌼"
                    rel="3">小菊的语义分割🌼</a>
        
                <a data-sort="0046" 
                    href="/archive/?tag=Competition%F0%9F%90%B3"
                    title="Competition🐳"
                    rel="2">Competition🐳</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E9%98%B6%E6%AE%B5%E6%80%A7%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93%F0%9F%94%91"
                    title="阶段性学习总结🔑"
                    rel="1">阶段性学习总结🔑</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=Books%F0%9F%93%96"
                    title="Books📖"
                    rel="1">Books📖</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=GAN%26Image+Enhancement%F0%9F%90%BD"
                    title="GAN&Image Enhancement🐽"
                    rel="1">GAN&Image Enhancement🐽</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=NAS%F0%9F%91%A3"
                    title="NAS👣"
                    rel="1">NAS👣</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=PyTorch%F0%9F%A7%9F%E2%80%8D%E2%99%82%EF%B8%8F"
                    title="PyTorch🧟‍♂️"
                    rel="1">PyTorch🧟‍♂️</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://space.bilibili.com/481802918">Bilibili</a></li>
  
  <li><a href="https://blog.csdn.net/fuhao7i">CSDN</a></li>
  
</ul>

            </div>
        </div>
    </div>

</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->

<!--不蒜子统计-->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  <li><a target="_blank" href="mailto:2689378080@qq.com" rel="external nofollow noopener noreferrer"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li>
  <li><a target="_blank" href="https://wpa.qq.com/msgrd?v=3&amp;uin=2689378080&amp;site=qq&amp;menu=yes" rel="external nofollow noopener noreferrer"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-qq fa-stack-1x fa-inverse"></i></span></a></li>
  
  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/fuhao7i">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                <div class="copyright text-muted">
                    <!--不蒜子-->
                    <ul class="list-inline">
                        <li>
                            <link rel="stylesheet" href="/iconfont.css">
                            Total
                            <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span>
                            <span class="iconfont icon-jiaoyin"></span>views
                     
                        </li>
                        
                    </ul>
                    Copyright &copy; fuhao7i Blog 2021
                    <br>
                    
                    Powered by Hux Blog
                </div>

                    
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>







<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
