I"K…<blockquote>
  <p>é€šè¿‡å°èŠçš„è¯­ä¹‰åˆ†å‰²1ğŸŒ¼ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è¯­ä¹‰åˆ†å‰²å…¶å®å°±æ˜¯åƒç´ çº§çš„åˆ†ç±»ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒè¦åšçš„æ˜¯ç»™æ¯ä¸€ä¸ªåƒç´ ç‚¹è¿›è¡Œåˆ†ç±»ï¼Œé‚£æˆ‘ä»¬å…·ä½“åº”è¯¥æ€æ ·å®ç°è¿™ä¸ªç‰¹æ®Šçš„åˆ†ç±»ä»»åŠ¡å‘¢ï¼Ÿâ€”â€”â€”â€”ä¸æ€¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ™®é€šçš„å›¾åƒåˆ†ç±»ä»»åŠ¡æ˜¯æ€æ ·å®ç°çš„</p>
</blockquote>

<h1 id="0-å›¾åƒåˆ†ç±»ä»»åŠ¡å®ç°åŸç†">0. å›¾åƒåˆ†ç±»ä»»åŠ¡å®ç°åŸç†</h1>

<p>å…¶å®æˆ‘ä»¬çš„è¯­ä¹‰åˆ†å‰²â€”â€”åƒç´ çº§åˆ†ç±»å’Œæˆ‘ä»¬çš„æ™®é€šå›¾åƒåˆ†ç±»ä»»åŠ¡è¿˜æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªç»™åƒç´ ç‚¹è¿›è¡Œåˆ†ç±»ï¼Œä¸€ä¸ªç»™æ•´ä¸ªå›¾åƒè¿›è¡Œåˆ†ç±»ï¼Œå®ƒä»¬çš„æ ‡ç­¾å¤„ç†æ–¹å¼å’Œæœ€åçš„æŸå¤±è®¡ç®—éƒ½æ˜¯éå¸¸ç›¸ä¼¼çš„ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å‡è®¾æœ‰è¿™æ ·ä¸€å †å›¾ç‰‡ï¼Œé‡Œé¢æ€»å…±æœ‰3ä¸ªç±»â€”â€”çŒ«ï¼Œç‹—å’Œç‹¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®šä¹‰æ ‡ç­¾çš„æ—¶å€™å¯ä»¥å°†çŒ«ä½œä¸ºç¬¬0ç±»ï¼Œç‹—æ˜¯ç¬¬1ç±»ï¼Œç‹¼æ˜¯ç¬¬2ç±»ï¼Œç„¶åç»™å®ƒä»¬è½¬æ¢æˆåˆ†ç±»å¸¸ç”¨çš„one-hotç¼–ç æ ¼å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>

<pre><code class="language-Bash"> ç±»åˆ«    æ ‡ç­¾    one-hot  
 çŒ«      0      [1, 0, 0]
 ç‹—      1      [0, 1, 0]
 ç‹¼      2      [0, 0, 1]
</code></pre>

<p>æˆ‘ä»¬æŠŠæ¯ä¸€å¼ å›¾ç‰‡å’Œå®ƒçš„one-hotç¼–ç æ ¼å¼æ ‡ç­¾å¯¹åº”èµ·æ¥ï¼Œå°±å¯ä»¥ç”¨äºåé¢çš„æŸå¤±å‡½æ•°è®¡ç®—äº†ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹æˆ‘ä»¬çš„åˆ†ç±»ç½‘ç»œçš„è¾“å‡ºæ˜¯æ€æ ·çš„ã€‚åˆ†ç±»ç½‘ç»œçš„è¾“å‡ºæ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„[â€¦]ï¼Œå…·ä½“æ•°ç»„é‡Œé¢æœ‰å‡ ä¸ªå…ƒç´ å’Œæˆ‘ä»¬è¦åˆ†çš„ç±»åˆ«æœ‰å…³ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ†3ç±»ï¼Œæ•°ç»„çš„é•¿åº¦å°±ä¸º3â€”â€”â€”â€”[x0, x1, x2]ï¼Œä¹‹åæˆ‘ä»¬<code class="language-plaintext highlighter-rouge">Softmax([x0, x1, x2])</code>ï¼Œå¾—åˆ°[p0, p1, p2]ï¼Œå…¶ä¸­p0+p1+p2=1ï¼Œp0ä»£è¡¨çš„æ˜¯å›¾åƒä¸ºç¬¬0ç±»çš„æ¦‚ç‡ï¼Œp1ä»£è¡¨çš„æ˜¯å›¾åƒä¸ºç¬¬1ç±»çš„æ¦‚ç‡ï¼Œä»¥æ­¤ç±»æ¨ã€‚æœ€å¤§æ¦‚ç‡å¯¹åº”ç§ç±»å°±æ˜¯åˆ†ç±»ç½‘ç»œé¢„æµ‹çš„å›¾åƒçš„ç§ç±»ã€‚<code class="language-plaintext highlighter-rouge">ä¾‹</code> æˆ‘ä»¬å¾—åˆ°è¾“å‡º[0.1, 0.7, 0.2]ï¼Œå…¶ä¸­æœ€å¤§æ¦‚ç‡0.7å¯¹åº”çš„ç±»åˆ«ä¸º1ï¼Œåˆ™åˆ†ç±»ç½‘ç»œä»»åŠ¡è¯¥å›¾åƒä¸ºç‹—ã€‚</p>

<p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åˆ†ç±»ç½‘ç»œæŸå¤±çš„è®¡ç®—ï¼š<strong>äº¤å‰ç†µ</strong></p>

\[\large loss = - (\sum\limits_{i=1}^N y\_true_i * ln( y\_pre_i )) \tag {1}\]

<p>å…¶ä¸­ <strong>$0 &lt; y_{pre}_i &lt;= 1$</strong>ã€‚å› ä¸ºæˆ‘ä»¬çš„y_trueåªæœ‰ä¸€ä¸ªä¸º1ï¼Œå…¶ä½™å…¨ä¸º0ï¼Œå¸¦å…¥å¯å¾—æˆ‘ä»¬çš„æŸå¤±ä¸º <strong>$loss = - ln( y_pre_label )$</strong>ï¼Œlnå‡½æ•°åœ¨<strong>(0,1]</strong>ä¸ºå¢å‡½æ•°ï¼ŒåŠ ä¸Šè´Ÿå·ä¸ºå‡å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„åˆ†ç±»ç½‘ç»œåªæœ‰æé«˜å›¾åƒåˆ†ç±»æ­£ç¡®çš„æ¦‚ç‡ï¼Œæˆ‘ä»¬çš„lossæ‰ä¼šå‡å°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">æŸå¤±ç†è§£:</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="c1"># ç±»åˆ«    æ ‡ç­¾    one-hot  
# çŒ«      0      [1, 0, 0]
# ç‹—      1      [0, 1, 0]
# ç‹¼      2      [0, 0, 1]
</span>
<span class="k">def</span> <span class="nf">crossentropy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]])</span>


<span class="k">print</span><span class="p">(</span><span class="s">"Keras:"</span><span class="p">,</span> <span class="n">K</span><span class="p">.</span><span class="n">categorical_crossentropy</span><span class="p">(</span><span class="n">K</span><span class="p">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">K</span><span class="p">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)))</span>

<span class="n">loss1</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">loss2</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">loss1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss1</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">loss2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">loss2</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">loss1</span> <span class="o">+=</span> <span class="n">crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">loss2</span> <span class="o">+=</span> <span class="n">crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  

<span class="k">print</span><span class="p">(</span><span class="s">"ours :"</span><span class="p">,</span> <span class="n">loss1</span><span class="p">,</span> <span class="n">loss2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<pre><code class="language-Bash">Keras: tf.Tensor([0.5108256 1.2039728], shape=(2,), dtype=float32)
ours : 0.51082563 1.2039728
</code></pre>

<p>çœ‹æ‡‚äº†æ™®é€šçš„å›¾åƒåˆ†ç±»ä»»åŠ¡ä¹‹åï¼Œå†çœ‹æˆ‘ä»¬çš„è¯­ä¹‰åˆ†å‰²ï¼Œå…¶å®å°±æ˜¯ç»™æ¯ä¸€ä¸ªåƒç´ ç‚¹å¯¹åº”ä¸€ä¸ªone-hotç¼–ç æ ‡ç­¾ï¼Œä¹‹åæˆ‘ä»¬çš„è¯­ä¹‰åˆ†å‰²ç½‘ç»œçš„è¾“å‡ºå’Œåˆ†ç±»ç½‘ç»œçš„è¾“å‡ºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¼šè¾“å‡ºæ¯ä¸€ä¸ªåƒç´ ç‚¹å¯¹åº”æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="language-Bash">       Output              Label
 [[0.4, 0.3, 0.3],      [[1, 0, 0],        # ç¬¬1ä¸ªåƒç´ ç‚¹
  [0.7, 0.2, 0.1],       [1, 0, 0],        # ç¬¬2ä¸ªåƒç´ ç‚¹
  [0.8, 0.2, 0.0],       [1, 0, 0],        # ç¬¬ä¸‰ä¸ªåƒç´ ç‚¹
  [0.8, 0.1, 0.1],       [1, 0, 0],        # ç¬¬å››ä¸ªåƒç´ ç‚¹
        ...                 ...
                 ]
</code></pre>

<p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒåœ¨è¯­ä¹‰åˆ†å‰²ä¸­æ˜¯æ€æ ·å…·ä½“å®ç°çš„å§</p>

<h1 id="1-æ•°æ®é¢„å¤„ç†">1. æ•°æ®é¢„å¤„ç†</h1>

<p><code class="language-plaintext highlighter-rouge">æ€è·¯:</code> è¯»å–train.txtæ–‡ä»¶ï¼Œè·å–è®­ç»ƒå›¾åƒåŠå¯¹åº”æ ‡ç­¾çš„æ–‡ä»¶è·¯å¾„ï¼Œè¯»å–å›¾åƒï¼Œå°†å›¾åƒè½¬åŒ–ä¸º<code class="language-plaintext highlighter-rouge">tensor</code>ä¹‹åï¼Œ<code class="language-plaintext highlighter-rouge">resize</code>è°ƒæ•´å›¾åƒå°ºå¯¸å¤§å°å¹¶è¿›è¡Œ<code class="language-plaintext highlighter-rouge">å½’ä¸€åŒ–å¤„ç†</code>ï¼Œä¹‹åä¹Ÿå¯é€šè¿‡æ—‹è½¬ï¼Œè‰²åï¼Œå¢åŠ å™ªå£°ç­‰æ–¹å¼è¿›è¡Œ<code class="language-plaintext highlighter-rouge">æ•°æ®å¢å¼º</code>ã€‚æ³¨æ„è¦ä¿è¯å›¾åƒå’Œæ ‡ç­¾çš„å¤„ç†ä¸€è‡´ã€‚</p>

<p><img src="https://img-blog.csdnimg.cn/20210327141350996.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">paddingå¯ä»¥ä½¿å›¾åƒåœ¨resizeæ—¶ä¸å¤±çœŸ</code></p>

<h1 id="2-label-map-æ ‡ç­¾æ˜ å°„">2. label map æ ‡ç­¾æ˜ å°„</h1>

<p><img src="https://img-blog.csdnimg.cn/20210328145544433.png" center="" /></p>

<p>å¦‚å›¾å°±æ˜¯æˆ‘ä»¬çš„è¯­ä¹‰åˆ†å‰²æ ‡ç­¾å›¾åƒï¼Œç›¸åŒé¢œè‰²(åƒç´ å€¼)çš„åƒç´ ç‚¹ä»£è¡¨çš„æ˜¯åŒä¸€ç±»ç‰©ä½“ã€‚å‡è®¾åƒæˆ‘ä»¬è¿™ä¸ªæ ‡ç­¾å›¾åƒæ‰€å±•ç¤ºçš„é‚£æ ·ï¼Œæˆ‘ä»¬éœ€è¦åˆ†å‰²å‡ºæ¥å›¾ç‰‡ä¸­çš„çŒ«å’Œç‹—ï¼Œé‚£å¯¹æˆ‘ä»¬çš„è¯­ä¹‰åˆ†å‰²ä»»åŠ¡æ¥è¯´å°±æ˜¯æ€»å…±è¦åˆ†3ç±»ï¼š0 èƒŒæ™¯ï¼›1 çŒ«ï¼›2 ç‹—ï¼›å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">[Height, Width, N_classes]</code>æ•°ç»„æ¥è¡¨ç¤ºæ¯ä¸€ä¸ªåƒç´ ç‚¹çš„ç±»åˆ«ï¼›å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://img-blog.csdnimg.cn/20210328145242405.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">label[0, 0] = [1, 0, 0]</code> è¯´æ˜[0, 0]ä½ç½®æ˜¯èƒŒæ™¯ï¼Œ<code class="language-plaintext highlighter-rouge">label[1, 1] = [0, 1, 0]</code>è¯´æ˜[1, 1]è¿™ä¸ªåƒç´ ç‚¹å±äºçŒ«ã€‚æˆ‘ä»¬<code class="language-plaintext highlighter-rouge">Reshape</code>ä¹‹åå¥½åƒæ›´æ–¹ä¾¿å¤§å®¶ç†è§£:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NCLASSES</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>one-hot ç¼–ç </strong></p>
<pre><code class="language-Bash">
 [[1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [1, 0, 0],
  [0, 1, 0],
  [0, 0, 1],
  [0, 0, 1],
     ...
           ]
</code></pre>

<p>è¿™å°±æ˜¯æˆ‘ä»¬æœ€åç”¨æ¥å’Œé¢„æµ‹ç»“æœè®¡ç®—æŸå¤±çš„æ•°æ®å•¦ğŸŒ¼<code class="language-plaintext highlighter-rouge">ç›¸ä¿¡å¤§å®¶å¯¹ä¸ºä»€ä¹ˆè¿™æ ·åšè¿˜æœ‰ç‚¹äº‘é‡Œé›¾é‡Œçš„æ„Ÿè§‰ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ­å¼€è¯­ä¹‰åˆ†å‰²çš„ç¥ç§˜é¢çº±å§ğŸŒ¼</code></p>

<h1 id="3-åƒç´ çº§åˆ†ç±»åŸç†">3. åƒç´ çº§åˆ†ç±»åŸç†</h1>

<p>äº†è§£å®Œlableçš„å…·ä½“æ ¼å¼ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç½‘ç»œçš„æœ€åå‡ å±‚è®¾è®¡:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'vaild'</span> <span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">Reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_classes</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">Softmax</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸ªå’Œæˆ‘ä»¬labelçš„å¤„ç†æ˜¯ä¸€è‡´çš„ï¼Œè¾“å‡ºçš„æ˜¯æ¯ä¸€ä¸ªåƒç´ ç‚¹å±äºå“ªä¸€ç±»çš„æ¦‚ç‡ï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://img-blog.csdnimg.cn/20210328152456675.png" center="" /></p>

<p><code class="language-plaintext highlighter-rouge">tensorè¡¨ç¤º:</code></p>
<pre><code class="language-Bash">       Output              Label
 [[0.4, 0.3, 0.3],      [[1, 0, 0],
  [0.7, 0.2, 0.1],       [1, 0, 0],
  [0.8, 0.2, 0.0],       [1, 0, 0],
  [0.8, 0.1, 0.1],       [1, 0, 0],
        ...                 ...
                 ]
</code></pre>

<p>å°†æˆ‘ä»¬å¤„ç†ä¹‹åçš„labelå’Œé¢„æµ‹å¾—åˆ°çš„ç»“æœä¼ ç»™æˆ‘ä»¬çš„æŸå¤±å‡½æ•°å°±èƒ½è®¡ç®—å‡ºlossäº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®ç°äº†åƒç´ çº§çš„åˆ†ç±»â€”â€”â€”â€”ä¹Ÿå°±æ˜¯<code class="language-plaintext highlighter-rouge">è¯­ä¹‰åˆ†å‰²</code>äº†ğŸŒ¼</p>

<h3 id="å¸®åŠ©ç†è§£æ ‡ç­¾çš„å¤„ç†">å¸®åŠ©ç†è§£æ ‡ç­¾çš„å¤„ç†</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
     <span class="c1"># é»˜è®¤èƒŒæ™¯ä¸º0
</span>     <span class="mi">76</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># å»ºç­‘ç‰©
</span>    <span class="mi">150</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># æ¤è¢«
</span>    <span class="mi">255</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="c1"># é“è·¯
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">76</span><span class="p">],</span>
          <span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="mi">255</span><span class="p">]]</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'int'</span><span class="p">)</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">:</span>
    <span class="n">labelmap</span><span class="p">[(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">labelmap</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">labelmap</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">labelmap</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">labelmap</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>ä¸‹é¢æ˜¯åŒ…å«äº†æ•°æ®é¢„å¤„ç†ï¼ŒæŸå¤±å®šä¹‰ç­‰æ•´ä¸ªæ¨¡å‹è®­ç»ƒè¿‡ç¨‹çš„train.pyæ–‡ä»¶ï¼Œå¤§å®¶ç¨ä½œä¿®æ”¹å°±å¯ä»¥è®­ç»ƒè‡ªå·±çš„è¯­ä¹‰åˆ†å‰²æ¨¡å‹äº†ğŸŒ¼</strong></p>

<p><strong><a href="https://keras.io/zh/models/model/">Keraså®ç°</a></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Lambda</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">EarlyStopping</span>

<span class="c1"># æ ‡ç­¾åƒç´ å€¼å¯¹åº”çš„ç‰©ä½“ç±»åˆ«, 0ä¸ºèƒŒæ™¯
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'[0 0 0]'</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># èƒŒæ™¯
</span>    <span class="s">'[7 7 7]'</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'[26 26 26]'</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">576</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">576</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># train.txtå’Œval.txtçš„æ–‡ä»¶è·¯å¾„
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">''</span>

<span class="c1"># trainçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">''</span>
<span class="c1"># valçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">''</span>


<span class="c1"># labelsæ˜ å°„
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">labelmap</span>


<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">],</span> \
        <span class="s">'mode must be ethier </span><span class="se">\'</span><span class="s">train</span><span class="se">\'</span><span class="s"> or </span><span class="se">\'</span><span class="s">val</span><span class="se">\'</span><span class="s">'</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Yval</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Ylabel</span> 

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path0</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span><span class="n">WIDTH</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mi">255</span>
            <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path1</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">label_map</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">NCLASSES</span><span class="p">))</span>

            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>

<span class="c1"># å®šä¹‰æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">crossloss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">crossloss</span><span class="p">)</span><span class="o">/</span><span class="n">HEIGHT</span><span class="o">/</span><span class="n">WIDTH</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    
    <span class="c1"># ç”¨äºæœ€åä¿å­˜æ¨¡å‹çš„è·¯å¾„
</span>    <span class="n">log_dir</span> <span class="o">=</span> <span class="s">''</span>

    <span class="c1"># åˆ›å»ºæ¨¡å‹
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>

    <span class="c1"># è·å–è®­ç»ƒæ ·æœ¬å’ŒéªŒè¯æ ·æœ¬çš„æ•°ç›®
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


    <span class="c1"># è®¾ç½®å­¦ä¹ ç‡ä¸‹é™æ–¹æ³•,val_losséªŒè¯æŸå¤±è¿ç»­5ä¸ªepochä¸ä¸‹é™å°±è®©å­¦ä¹ ç‡å‡åŠ
</span>    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># æ˜¯å¦éœ€è¦æ—©åœï¼Œå½“val_lossä¸€ç›´ä¸ä¸‹é™çš„æ—¶å€™æ„å‘³ç€æ¨¡å‹åŸºæœ¬è®­ç»ƒå®Œæ¯•ï¼Œå¯ä»¥åœæ­¢
</span>    <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">min_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># è®¾ç½®æŸå¤±ï¼Œä¼˜åŒ–å™¨
</span>    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">,</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Train on {} samples, val on {} samples, with batch size {}.'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_val</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">))</span>

    <span class="c1"># å¼€å§‹è®­ç»ƒ
</span>    <span class="n">model</span><span class="p">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'train'</span><span class="p">),</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_train</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'val'</span><span class="p">),</span>
            <span class="n">validation_steps</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_val</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
            <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">reduce_lr</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">])</span>

    <span class="n">model</span><span class="p">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">log_dir</span><span class="o">+</span><span class="s">'Dali.h5'</span><span class="p">)</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">ä¸Šé¢çš„æ ‡ç­¾å¤„ç†æ–¹ä¾¿ç†è§£ï¼Œä½†æ˜¯æ—¶é—´å¤æ‚åº¦é«˜ï¼Œåœ¨cupä¸Šå¤„ç†æ…¢ï¼Œä¸‹é¢ä¸ºæ”¹è¿›ç‰ˆæœ¬:</code></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="c1"># import keras
</span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Lambda</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span><span class="p">,</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.utils</span> <span class="kn">import</span> <span class="n">to_categorical</span>
<span class="kn">from</span> <span class="nn">models.decoders.segnet</span> <span class="kn">import</span> <span class="n">resnet50_segnet</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># logging æ¨¡å—, ä¿å­˜æ—¥å¿—æ–‡ä»¶
# ===================&gt;
</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">'./work_dirs/segnet/segnet.log'</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">'a'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">handlers</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>

<span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">logger</span><span class="p">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
<span class="c1"># &lt;==================
</span>
<span class="c1"># æ ‡ç­¾åƒç´ å€¼å¯¹åº”çš„ç‰©ä½“ç±»åˆ«, 0ä¸ºèƒŒæ™¯
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># é»˜è®¤èƒŒæ™¯ä¸º0
</span>     <span class="mi">76</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># å»ºç­‘ç‰©
</span>    <span class="mi">150</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># æ¤è¢«
</span>    <span class="mi">255</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># é“è·¯
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># train.txtå’Œval.txtçš„æ–‡ä»¶è·¯å¾„
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">'./dataset/train.txt'</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">'./dataset/val.txt'</span>

<span class="c1"># trainçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">'./dataset/jpg/'</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">'./dataset/png/'</span>
<span class="c1"># valçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">'./dataset/val_jpg/'</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">'./dataset/val_png/'</span>


<span class="c1"># labelsæ˜ å°„
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">labelmap</span>


<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">],</span> \
        <span class="s">'mode must be ethier </span><span class="se">\'</span><span class="s">train</span><span class="se">\'</span><span class="s"> or </span><span class="se">\'</span><span class="s">val</span><span class="se">\'</span><span class="s">'</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">path0</span> <span class="o">=</span> <span class="n">path_Yval</span>
        <span class="n">path1</span> <span class="o">=</span> <span class="n">path_Ylabel</span> 

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path0</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span><span class="n">WIDTH</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">/</span><span class="mi">255</span>
            <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path1</span> <span class="o">+</span> <span class="n">name</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'L'</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">resize</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">:</span>
                <span class="n">seg_labels</span><span class="p">[(</span><span class="n">img</span> <span class="o">==</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">seg_labels</span> <span class="o">=</span> <span class="n">to_categorical</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">,</span> <span class="n">NCLASSES</span><span class="p">)</span>
            <span class="c1"># print(seg_labels)
</span>            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_labels</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">))</span>

<span class="c1"># å®šä¹‰æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">crossloss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">crossloss</span><span class="p">)</span><span class="o">/</span><span class="n">HEIGHT</span><span class="o">/</span><span class="n">WIDTH</span>

    <span class="k">return</span> <span class="n">loss</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    
    <span class="c1"># ç”¨äºæœ€åä¿å­˜æ¨¡å‹çš„è·¯å¾„
</span>    <span class="n">log_dir</span> <span class="o">=</span> <span class="s">'./work_dirs/segnet/'</span>

    <span class="c1"># åˆ›å»ºæ¨¡å‹
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">resnet50_segnet</span><span class="p">(</span><span class="n">n_classes</span><span class="o">=</span><span class="n">NCLASSES</span><span class="p">,</span> <span class="n">input_height</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="n">input_width</span><span class="o">=</span><span class="n">WIDTH</span><span class="p">)</span>

    <span class="c1"># è·å–è®­ç»ƒæ ·æœ¬å’ŒéªŒè¯æ ·æœ¬çš„æ•°ç›®
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">num_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


    <span class="c1"># è®¾ç½®å­¦ä¹ ç‡ä¸‹é™æ–¹æ³•,val_losséªŒè¯æŸå¤±è¿ç»­5ä¸ªepochä¸ä¸‹é™å°±è®©å­¦ä¹ ç‡å‡åŠ
</span>    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># æ˜¯å¦éœ€è¦æ—©åœï¼Œå½“val_lossä¸€ç›´ä¸ä¸‹é™çš„æ—¶å€™æ„å‘³ç€æ¨¡å‹åŸºæœ¬è®­ç»ƒå®Œæ¯•ï¼Œå¯ä»¥åœæ­¢
</span>    <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
                            <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                            <span class="n">min_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                            <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
    <span class="c1"># è®¾ç½®æŸå¤±ï¼Œä¼˜åŒ–å™¨
</span>    <span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">,</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">),</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">'Train on {} samples, val on {} samples, with batch size {}.'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_val</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">))</span>
    <span class="c1"># print('Train on {} samples, val on {} samples, with batch size {}.'.format(num_train, num_val, BATCH_SIZE))
</span>
    <span class="c1"># å¼€å§‹è®­ç»ƒ
</span>    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'train'</span><span class="p">),</span>
              <span class="n">steps_per_epoch</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_train</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
              <span class="n">validation_data</span><span class="o">=</span><span class="n">data_generator</span><span class="p">(</span><span class="s">'val'</span><span class="p">),</span>
              <span class="n">validation_steps</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_val</span><span class="o">//</span><span class="n">BATCH_SIZE</span><span class="p">),</span>
              <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
              <span class="n">initial_epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">reduce_lr</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">])</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">log_dir</span><span class="o">+</span><span class="s">'segnet.h5'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong><a href="https://fuhao7i.com/2021/03/12/dalitools2/">PyTorchå®ç°</a></strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="c1"># ===================&gt;
</span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="p">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">'./work_dirs/segnet/segnet.log'</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s">'a'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="p">)</span>

<span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">console</span><span class="p">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="n">logger</span><span class="p">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
<span class="c1"># &lt;==================
</span>
<span class="c1"># æ ‡ç­¾åƒç´ å€¼å¯¹åº”çš„ç‰©ä½“ç±»åˆ«, 0ä¸ºèƒŒæ™¯
</span><span class="n">CLASSES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'[0 0 0]'</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1"># èƒŒæ™¯
</span>    <span class="s">'[22 0 255]'</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># å»ºç­‘ç‰©
</span>    <span class="s">'[0 255 0]'</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># æ¤è¢«
</span>    <span class="s">'[255 255 255]'</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="c1"># é“è·¯
</span><span class="p">}</span>

<span class="n">NCLASSES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># train.txtå’Œval.txtçš„æ–‡ä»¶è·¯å¾„
</span><span class="n">path_train_txt</span> <span class="o">=</span> <span class="s">'./dataset/train.txt'</span>
<span class="n">path_val_txt</span> <span class="o">=</span> <span class="s">'./dataset/val.txt'</span>

<span class="c1"># trainçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Xtrain</span> <span class="o">=</span> <span class="s">'./dataset/jpg/'</span>
<span class="n">path_Xlabel</span> <span class="o">=</span> <span class="s">'./dataset/png/'</span>
<span class="c1"># valçš„å›¾åƒå’Œæ ‡ç­¾è·¯å¾„
</span><span class="n">path_Yval</span> <span class="o">=</span> <span class="s">'./dataset/val_jpg/'</span>
<span class="n">path_Ylabel</span> <span class="o">=</span> <span class="s">'./dataset/val_png/'</span>



<span class="c1"># labelsæ˜ å°„
</span><span class="k">def</span> <span class="nf">label_map</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="n">labelmap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">),</span><span class="n">NCLASSES</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HEIGHT</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span> <span class="ow">in</span> <span class="n">CLASSES</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">CLASSES</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">labelmap</span><span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">labelmap</span>

<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>  <span class="c1"># åˆ›å»ºç±»ï¼šMyDataset,ç»§æ‰¿torch.utils.data.Dataset
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatxt</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">datatxt</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>  <span class="c1"># æ‰“å¼€txtï¼Œè¯»å–å†…å®¹
</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>  <span class="c1"># æŒ‰è¡Œå¾ªç¯txtæ–‡æœ¬ä¸­çš„å†…å®¹
</span>            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)</span>  <span class="c1"># é€šè¿‡æŒ‡å®šåˆ†éš”ç¬¦å¯¹å­—ç¬¦ä¸²è¿›è¡Œåˆ‡ç‰‡
</span>            <span class="n">data</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>  <span class="c1"># æŠŠtxté‡Œçš„å†…å®¹è¯»å…¥dataåˆ—è¡¨ä¿å­˜ï¼Œwords[0]æ˜¯å›¾ç‰‡ä¿¡æ¯ï¼Œwords[1]æ˜¯label
</span>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">path_train</span> <span class="o">=</span> <span class="n">path_Xtrain</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">path_label</span> <span class="o">=</span> <span class="n">path_Xlabel</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>  <span class="c1"># æŒ‰ç…§ç´¢å¼•è¯»å–æ¯ä¸ªå…ƒç´ çš„å…·ä½“å†…å®¹
</span>        <span class="n">fn</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># fnæ˜¯å›¾ç‰‡path
</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_train</span> <span class="o">+</span> <span class="n">fn</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path_label</span> <span class="o">+</span> <span class="n">fn</span><span class="p">).</span><span class="n">convert</span><span class="p">(</span><span class="s">'RGB'</span><span class="p">)</span>



        <span class="c1"># from PIL import Image
</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># æ˜¯å¦è¿›è¡Œtransform
</span>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span>  <span class="c1"># returnå›å“ªäº›å†…å®¹ï¼Œåœ¨è®­ç»ƒæ—¶å¾ªç¯è¯»å–æ¯ä¸ªbatchï¼Œå°±èƒ½è·å¾—å“ªäº›å†…å®¹
</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># å®ƒè¿”å›çš„æ˜¯æ•°æ®é›†çš„é•¿åº¦ï¼Œå¿…é¡»æœ‰
</span>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>


    
    <span class="c1"># å®ä¾‹åŒ–ç½‘ç»œ
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
    <span class="c1"># print(model)
</span>    
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span>  <span class="n">model</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="n">train_transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
     
        <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
        <span class="p">])</span>
    
    <span class="n">val_transforms</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
    <span class="p">])</span>

    <span class="n">train_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">datatxt</span><span class="o">=</span><span class="n">path_train_txt</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transforms</span><span class="p">)</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">val_data</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">(</span><span class="n">datatxt</span><span class="o">=</span><span class="n">path_val_txt</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">val_transforms</span><span class="p">)</span>
    <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">val_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">backbone</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>

    <span class="c1"># print('backbone parameters:', model.module.backbone)
</span>    <span class="n">num_epoches</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

    <span class="n">val_acc_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_model_wts</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
    <span class="n">best_acc</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># pretrained_dict = torch.load('/content/drive/MyDrive/search/mmdetection/data/resneXt_imagenet.pth')
</span>    <span class="c1"># model_dict = model.state_dict()
</span>    <span class="c1"># pretrained_dict = {k: v for k, v in pretrained_dict.items() if 'classifier' not in k}
</span>    <span class="c1"># for k in pretrained_dict:
</span>    <span class="c1">#     print(k)
</span>    <span class="c1"># model_dict.update(pretrained_dict)
</span>    <span class="c1"># model.load_state_dict(model_dict)
</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epoches</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Epoch {}/{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_epoches</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'-'</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'train'</span><span class="p">,</span> <span class="s">'val'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
                <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Set model to training mode
</span>
                <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">running_corrects</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
                    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
                    <span class="c1"># print(labels)
</span>                    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>       

                    <span class="n">image</span><span class="p">[</span><span class="s">'img'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    <span class="n">image</span><span class="p">[</span><span class="s">'img_metas'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>

                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">extract_backbone</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
                    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
                    
                    <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="k">print</span><span class="p">(</span><span class="s">'loss:'</span><span class="p">,</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
                    <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">running_corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="c1"># print('{}/{}'.format(i * 50, len(train_loader.dataset)))
</span>
                <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">epoch_acc</span> <span class="o">=</span> <span class="n">running_corrects</span><span class="p">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>

                <span class="k">print</span><span class="p">(</span><span class="s">' Loss: {:.4f}, acc: {:.6f} , running_loss: {:6f} , len: {:.6f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_acc</span><span class="p">,</span> <span class="n">running_loss</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)))</span>    


            <span class="k">else</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>     
                <span class="c1"># if epoch &lt; 10:
</span>                <span class="c1">#     break
</span>                <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>   <span class="c1"># Set model to evaluate mode
</span>                
                <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">running_corrects</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">):</span>

                    <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">gpu_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># print(labels)
</span>                    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>

                    <span class="n">image</span><span class="p">[</span><span class="s">'img'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    <span class="n">image</span><span class="p">[</span><span class="s">'img_metas'</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span>
                    
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">extract_backbone</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
                    <span class="c1"># print(outputs.shape, labels.shape)
</span>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
                    
                    <span class="n">_</span><span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


                    <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">running_corrects</span> <span class="o">+=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">preds</span> <span class="o">==</span> <span class="n">labels</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># epoch_loss = running_loss / 1000.0
</span>                <span class="c1"># epoch_acc = running_corrects.double() / 1000.0
</span>                <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">epoch_acc</span> <span class="o">=</span> <span class="n">running_corrects</span><span class="p">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>

                <span class="k">print</span><span class="p">(</span><span class="s">' Val_loss: {:.4f}, Val_acc: {:.6f} '</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_acc</span><span class="p">))</span>
            
                <span class="k">if</span> <span class="n">epoch_acc</span> <span class="o">&gt;</span> <span class="n">best_acc</span><span class="p">:</span>
                    <span class="n">best_acc</span> <span class="o">=</span> <span class="n">epoch_acc</span>
                    <span class="n">best_model_wts</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>
                    <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">best_model_wts</span><span class="p">,</span> <span class="s">'/content/drive/MyDrive/search/mmdetection/data/middle.pth'</span><span class="p">)</span>
                <span class="n">val_acc_history</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_acc</span><span class="p">)</span>

            <span class="k">print</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Best val Acc: {:4f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">best_acc</span><span class="p">))</span>
              
    <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">best_model_wts</span><span class="p">,</span> <span class="s">'/content/drive/MyDrive/search/mmdetection/data/resneXt_imagenet_338x600_best.pth'</span><span class="p">)</span>




<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>
:ET